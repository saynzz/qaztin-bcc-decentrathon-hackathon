from datetime import datetime

def generate_push(client_code, product, features, tone='friendly'):
    name = str(client_code)
    month = datetime.now().strftime('%B').lower()
    cats = features.get('top_categories', 'категории не определены').split(', ')
    cat1, cat2, cat3 = cats[:3] if len(cats) >= 3 else ['категория1', 'категория2', 'категория3']
    avg_amount = round(features.get('avg_transaction_amount', 0), 2)
    cashback_estimate = round(avg_amount * 0.04, -2)

    templates = {
        'Карта с кэшбэком': {
            'friendly': f"Привет, {name}! Вы часто тратите на {cat1}, {cat2}, {cat3}. С картой с кэшбэком можно вернуть ≈{cashback_estimate} ₸. Оформим?",
            'smart': f"Ваши траты в {cat1}, {cat2}, {cat3} могут приносить кешбэк. Сумма возврата — до {cashback_estimate} ₸. Проверьте условия.",
            'business': f"{name}, по вашим тратам в {cat1}, {cat2}, {cat3} рекомендована карта с кешбэком. Потенциальная выгода — {cashback_estimate} ₸."
        },
        'Карта для путешествий': {
            'friendly': f"{name}, в {month} у вас много поездок и такси. С тревел-картой часть расходов вернулась бы кешбэком. Оформим?",
            'smart': f"Поездки, отели, такси → тревел-карта с бонусами и возвратом. Проверьте выгоду.",
            'business': f"{name}, активность в тревел-сегменте → тревел-карта. Оптимизация расходов в поездках."
        },
        'Кредит наличными': {
            'friendly': f"{name}, если нужен запас на крупные траты — можно оформить кредит наличными с гибкими выплатами. Узнать лимит?",
            'smart': f"Сигналы потребности в финансах → кредит наличными. Рассчитайте доступную сумму.",
            'business': f"{name}, на основе операций рекомендован кредит наличными. Гибкие условия — по запросу."
        },
        'Депозит Накопительный': {
            'friendly': f"{name}, у вас остаются свободные средства. Разместите их на вкладе — удобно копить и получать доход. Открыть вклад?",
            'smart': f"Низкие траты и остаток >500k ₸ — сигнал для накопительного депозита. Проверьте доходность.",
            'business': f"{name}, на основе остатка и поведения рекомендован накопительный вклад. Оптимизация средств — разумный шаг."
        },
        'Премиальная карта': {
            'friendly': f"{name}, у вас крупный остаток и траты в ресторанах. Премиальная карта даст кешбэк и бесплатные снятия. Оформим?",
            'smart': f"Премиальная карта — для клиентов с высоким остатком и люкс-тратами. Проверьте преимущества.",
            'business': f"{name}, рекомендована премиальная карта. Повышенный кешбэк и премиальные условия."
        },
        'Кредитная карта': {
            'friendly': f"{name}, ваши любимые категории — {cat1}, {cat2}, {cat3}. Кредитная карта даст кешбэк и гибкие условия. Оформим?",
            'smart': f"Нестабильные траты и активность → кредитная карта с бонусами и лимитом. Подходит вам?",
            'business': f"{name}, по нестабильным тратам рекомендована кредитная карта. Условия — индивидуальные."
        },
        'Обмен валют': {
            'friendly': f"{name}, вы часто платите в валюте. В приложении — выгодный обмен и авто-покупка. Настроим?",
            'smart': f"FX-переводы → подключите автообмен по целевому курсу. Удобно и выгодно.",
            'business': f"{name}, активность в валютных операциях → FX-продукт. Настройка обмена — в 1 клик."
        },
        'Инвестиции': {
            'friendly': f"{name}, попробуйте инвестиции с низким порогом входа и без комиссий на старт. Откроем счёт?",
            'smart': f"Инвест-сигналы → портфель с низким риском и гибким входом. Проверьте предложения.",
            'business': f"{name}, рекомендованы инвестиции. Старт без комиссии, вход от 1 000 ₸."
        }
    }

    return templates.get(product, {}).get(tone, f"{name}, вам может подойти продукт: {product}.")
